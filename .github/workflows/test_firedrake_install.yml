name: 'Test Firedrake Installation'

on:
  # Trigger when this or any file in the install directory changes
  pull_request:
    paths:
      - 'install/**'
      - '.github/workflows/test_firedrake_install.yml'

  # Trigger the workflow on the 1st day of every month at midnight
  schedule:
    - cron: '0 0 1 * *'

  # Manually trigger the workflow
  workflow_dispatch:

# Stop the workflow if a new run is requested
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  install_firedrake:
    name: 'Install Firedrake'
    runs-on: ubuntu-latest
    container:
      image: firedrakeproject/firedrake-env:latest
      options: --user root

    steps:
      - name: 'Download firedrake-configure script'
        run: |
          sudo curl -O https://raw.githubusercontent.com/firedrakeproject/firedrake/master/scripts/firedrake-configure

      - name: 'Install system dependencies'
        run: |
          sudo apt-get update
          sudo apt-get -y install $(python3 firedrake-configure --show-system-packages)

      - name: 'Install PETSc'
        run: |
          git clone --depth 1 https://github.com/firedrakeproject/petsc.git
          cd petsc
          python3 ../firedrake-configure --show-petsc-configure-options | \
            sed "s/$/ \
              --download-chaco \
              --download-eigen \
              --download-parmetis \
              --download-mmg \
              --download-parmmg/" | \
            xargs -L1 ./configure --with-make-np=12
          make PETSC_DIR=$(pwd) PETSC_ARCH=arch-firedrake-default all
          make check

      - name: 'Create a virtual environment and install Firedrake'
        # Install in editable mode to be able to access meshes in the
        # firedrake/firedrake/tests/meshes directory (needed for Animate tests)
        run: |
          python3 -m venv venv
          . venv/bin/activate
          export $(python3 firedrake-configure --show-env)
          git clone --depth 1 https://github.com/firedrakeproject/firedrake.git
          cd firedrake
          pip install --no-binary h5py -e .[test]

      - name: 'Install and test Animate'
        run: |
          . venv/bin/activate
          git clone --depth 1 https://github.com/mesh-adaptation/animate.git
          cd animate
          make install_dev
          make test

      - name: 'Install and test Goalie'
        if: ${{ !cancelled() }}
        run: |
          . venv/bin/activate
          git clone --depth 1 https://github.com/mesh-adaptation/goalie.git
          cd goalie
          make install_dev
          make test

      - name: 'Install and test Movement'
        if: ${{ !cancelled() }}
        run: |
          . venv/bin/activate
          git clone --depth 1 https://github.com/mesh-adaptation/movement.git
          cd movement
          make install_dev
          make test
